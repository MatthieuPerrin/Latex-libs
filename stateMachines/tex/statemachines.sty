% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{statemachines}[2025/06/08 Package for automata, puchdown automata and turing machines]

\RequirePackage{xcolor}
\RequirePackage{keyval}
\RequirePackage{etoolbox}
\RequirePackage{xparse}
\RequirePackage{tikz}
\usetikzlibrary{automata}
\usetikzlibrary{overlay-beamer-styles}
\usetikzlibrary{trees}

\providecommand{\blank}{\ensuremath{\#}}


\newcommand<>\sm@style@append[2]{\only#3{\tikzset{#1/.append style={#2},}}}
\newcommand<>\sm@style@set[2]{\only#3{\tikzset{#1/.style={#2},}}}

\overlay@completestyle{initial}
\overlay@completestyle{initial left}
\overlay@completestyle{initial right}
\overlay@completestyle{initial above}
\overlay@completestyle{initial below}
\overlay@completestyle{accepting}

\tikzset{
  grid size/.style={node distance=#1, x=#1, y=#1,},
}

\tikzset{
  smBox/.style={
    rectangle,
    rounded corners,
    fill=structure!20,
    draw,
    align=center
  },
  state before/.style={
    circle,
    minimum height=6mm,
    minimum width=6mm,
  },
  state after/.style={
    draw highlighted,
    text highlighted,
    fill highlighted,
    draw,
    rounded corners=3mm,
    anchor=mid,
    align=center,
  },
  smStateMachine/.style={
    shorten >=1pt, on grid, auto,
    initial text=,
    every initial by arrow/.append style={-latex},
    initial distance=3mm,
    every edge/.append style={-latex,draw highlighted, text highlighted,},
    loop/.append style={looseness=5},
    font={\footnotesize},
  },
  smAutomaton/.style={
    smStateMachine,
    grid size=12mm,
  },
  smPushdown/.style={
    smStateMachine,
    grid size=20mm,
    initial text=$\diamond$
  },
  smTuringMachine/.style={
    smStateMachine,
    grid size=20mm,
  },
  automaton/.style={smAutomaton,},
  pushdown/.style={smPushdown,},
  turingMachine/.style={smTuringMachine,},
}

\tikzset{leadsto/.style={decorate, decoration={snake, amplitude=.5mm, segment length=2mm, post=lineto, post length=1mm},->,},}

\newcommand<>\state[1][]{\node#2[state before,#1, state after]}

\newcommand\cloudPath[3][fade]{
  \begin{pgfonlayer}{background}
    \path  (#2) edge[draw=none] node[#1, fill, fill highlighted, opacity=.5, anchor=base, cloud, cloud puffs=11, cloud puff arc=120, aspect=2, inner ysep=5pt]{}  (#3);
  \end{pgfonlayer}
  \path[densely dotted, opacity=.7, #1] (#2) edge[bend left=5mm]  (#3);
  \path[densely dotted, opacity=.7, #1] (#2) edge                 (#3);
  \path[densely dotted, opacity=.7, #1] (#2) edge[bend right=5mm] (#3);
}



\newcommand\sm@cell@width{6mm}
\newcommand\sm@cell@height{6mm}
\newcommand\sm@head@size{2mm}
\newcommand\sm@draw@nextCell{}
\newcommand\sm@array@name{}

\colorlet{sm@head@color}{black}
\colorlet{sm@fill@alert}{black!30}
\colorlet{sm@fill@example}{black!20}
\colorlet{sm@fill@structure}{black!10}

\tikzset{sm@fill@default/.style={fill=none},sm@style@path/.style={-latex}}
\tikzset{smCloud/.style={anchor=mid, cloud, cloud puffs=11, cloud puff arc=120, aspect=2, inner ysep=1em},}

\tikzset{
  every cell fill/.style={fill highlighted,},
  cell fill/.style={every cell fill},
  every cell border/.style={draw highlighted,},
  cell border north/.style={every cell border,},
  cell border south/.style={every cell border,},
  cell border east/.style={every cell border,},
  cell border west/.style={every cell border,},
  every cell text/.style={text highlighted,},
  cell text/.style={every cell text, align=center,},
  %
  open north/.style={cell border north/.style={draw=none},},
  open south/.style={cell border south/.style={draw=none},},
  open east/.style={cell border east/.style={draw=none},},
  open west/.style={cell border west/.style={draw=none},},
  open/.style={open north, open south, open east, open west,},
  %  open both/.style={open before, open after,},
  cell dimension/.style={rectangle, minimum width=\sm@cell@width, minimum height=\sm@cell@height,},
}

\newcommand\sm@set@cell@width[1]{\renewcommand\sm@cell@width{#1}}
\newcommand\sm@set@cell@height[1]{\renewcommand\sm@cell@height{#1}}

\newcommand\sm@array@width{23mm}
\newcommand\sm@array@height{15mm}
\newcommand\sm@array@lc@width{\sm@array@width}
\newcommand\sm@array@lc@height{\sm@array@height}
\newcommand\sm@array@lc@header{}

\define@key{sm@options}{width}{\sm@set@cell@width{#1}}
\define@key{sm@options}{height}{\sm@set@cell@height{#1}}
\define@key{sm@options}{headsize}{\renewcommand\sm@head@size{#1}}
\define@key{sm@options}{size}{\sm@set@cell@width{#1}\sm@set@cell@height{#1}\renewcommand\sm@head@size{.33 * #1}}
\define@key{sm@options}{fill}{\sm@style@set{sm@fill@default}{fill=#1}}
\define@key{sm@options}{direction}{\def\smDirection{#1}\@nameuse{sm@config@direction@#1}}
\define@key{sm@options}{name}{\renewcommand\sm@array@name{#1}}
\define@key{sm@array@options}{width}{\renewcommand\sm@array@width{#1}}
\define@key{sm@array@options}{height}{\renewcommand\sm@array@height{#1}}
\define@key{sm@array@lc@options}{width}{\renewcommand\sm@array@lc@width{#1}}
\define@key{sm@array@lc@options}{height}{\renewcommand\sm@array@lc@height{#1}}
\define@key{sm@array@lc@options}{header}{\renewcommand\sm@array@lc@header{#1}}


\newcommand\sm@config@direction@north{%
  \let\sm@go\sm@go@north%
  \let\sm@head\smheadeast%
  \let\smheadfrom\sm@head@from@east%
  \tikzset{%
    open before/.style={open south,},%
    open after/.style={open north,},%
    open sides/.style={open east, open west,},%
  }%
}%
\newcommand\sm@config@direction@south{%
  \let\sm@go\sm@go@south%
  \let\sm@head\smheadwest%
  \let\smheadfrom\sm@head@from@west%
  \tikzset{%
    open before/.style={open north,},%
    open after/.style={open south,},%
    open sides/.style={open east, open west,},%
  }%
}%
\newcommand\sm@config@direction@east{%
  \let\sm@go\sm@go@east%
  \let\sm@head\smheadsouth%
  \let\smheadfrom\sm@head@from@south%
  \tikzset{%
    open before/.style={open west,},%
    open after/.style={open east,},%
    open sides/.style={open north, open south,},%
  }%
}%
\newcommand\sm@config@direction@west{%
  \let\sm@go\sm@go@west%
  \let\sm@head\smheadnorth%
  \let\smheadfrom\sm@head@from@north%
  \tikzset{%
    open before/.style={open east,},%
    open after/.style={open west,},%
    open sides/.style={open north, open south,},%
  }%
}%

\NewDocumentEnvironment{sm@array}{O{}}{%
  \begingroup%
  \setkeys{sm@options}{direction=east,size=7mm,#1}
  \begin{tikzpicture}[anchor=mid, x=\sm@cell@width, y=\sm@cell@height, inner sep=0, outer sep=0]
    \node[rectangle, text width=\sm@cell@width, text height=\sm@cell@height, inner sep=0pt, outer sep=0pt] (sm@cell@current) at (0,0) {};
    \sm@cell@save{sm@start@head}
    \sm@cell@save{sm@lc@head}
    \pgfresetboundingbox
}{
  \end{tikzpicture}%
  \endgroup%
}





\NewDocumentEnvironment{smarray}{O{}}{\begin{sm@array}[#1]}{\end{sm@array}}

\newcommand\cell[2][]{%
  \sm@go
  \sm@draw@cell{#1}{#2}
}

\newcommand\smsave[1]{\sm@cell@save{#1}}

\newcommand\smcolumn[2][]{%
  \begingroup
  \setkeys{sm@array@lc@options}{#1}%
  \sm@go@to{sm@lc@head}
  \sm@go@east[\sm@array@lc@width]
  \sm@cell@save{sm@lc@head}
  \ifdefempty{\sm@array@lc@header}{}{\node[anchor=south] at (sm@lc@head.south)  {\sm@array@lc@header};}
  \let\sm@go\sm@go@south
  #2
  \endgroup
}

\newcommand\smline[2][]{%
  \begingroup
  \setkeys{sm@array@lc@options}{#1}%
  \sm@go@to{sm@lc@head}
  \sm@go@south[\sm@array@lc@height]
  \sm@cell@save{sm@lc@head}
  \ifdefempty{\sm@array@lc@header}{}{\node[anchor=east] at (sm@lc@head.west)  {\sm@array@lc@header};}
  \let\sm@go\sm@go@east
  #2
  \endgroup
}

\NewDocumentEnvironment{word}{O{}}{%
  \begin{smarray}[direction=east,#1]%
}{%
  \end{smarray}%
}

\NewDocumentEnvironment{tape}{O{}}{%
  \begin{smarray}[direction=east,#1]%
    \cell[open before]{\dots}
}{%
  \cell[open after]{\dots}
  \end{smarray}%
}

\NewDocumentEnvironment{stack}{O{}}{%
  \begin{smarray}[direction=north,#1]%
}{%
  \cell[open after]{}
  \end{smarray}%
}

\NewDocumentEnvironment{smqueue}{O{}}{%
  \begin{smarray}[direction=east,#1]%
    \cell[open before]{$\rightarrow$}
}{%
  \cell[open after]{$\rightarrow$}
  \end{smarray}%
}





\newcommand\sm@draw@north[1]{\node[anchor=south, outer sep=0, inner sep=0] (sm@head) at (sm@cell@current.north) {#1};}
\newcommand\sm@draw@south[1]{\node[anchor=north, outer sep=0, inner sep=0] (sm@head) at (sm@cell@current.south) {#1};}
\newcommand\sm@draw@east [1]{\node[anchor=west,  outer sep=0, inner sep=0] (sm@head) at (sm@cell@current.east)  {#1};}
\newcommand\sm@draw@west [1]{\node[anchor=east,  outer sep=0, inner sep=0] (sm@head) at (sm@cell@current.west)  {#1};}

\newcommand\sm@cell@save[1]{\pgfnodealias{#1}{sm@cell@current}}
\newcommand\sm@go@to[1]{\pgfnodealias{sm@cell@current}{#1}}
\newcommand\sm@go@north[1][\dimexpr\y2-\y1\relax]{
  \pgfinterruptboundingbox
  \path let\p1 = (sm@cell@current.south west),\p2 = (sm@cell@current.north east) in
  node[rectangle, text width=\dimexpr\x2-\x1\relax, text height=#1, inner sep=0pt, outer sep=0pt, anchor=south] (sm@cell@current) at (sm@cell@current.north) {};
  \endpgfinterruptboundingbox
}
\newcommand\sm@go@south[1][\dimexpr\y2-\y1\relax]{
  \pgfinterruptboundingbox
  \path let\p1 = (sm@cell@current.south west),\p2 = (sm@cell@current.north east) in
  node[rectangle, text width=\dimexpr\x2-\x1\relax, text height=#1, inner sep=0pt, outer sep=0pt, anchor=north] (sm@cell@current) at (sm@cell@current.south) {};
  \endpgfinterruptboundingbox
}
\newcommand\sm@go@east[1][\dimexpr\x2-\x1\relax]{
  \pgfinterruptboundingbox
  \path let\p1 = (sm@cell@current.south west),\p2 = (sm@cell@current.north east) in
  node[rectangle, text width=#1, text height=\dimexpr\y2-\y1\relax, inner sep=0pt, outer sep=0pt, anchor=west]  (sm@cell@current) at (sm@cell@current.east) {};
  \endpgfinterruptboundingbox
}
\newcommand\sm@go@west[1][\dimexpr\x2-\x1\relax] {
  \pgfinterruptboundingbox
  \path let\p1 = (sm@cell@current.south west),\p2 = (sm@cell@current.north east) in
  node[rectangle, text width=#1, text height=\dimexpr\y2-\y1\relax, inner sep=0pt, outer sep=0pt, anchor=east]  (sm@cell@current) at (sm@cell@current.west) {};
  \endpgfinterruptboundingbox
}

\newcommand\sm@draw@cell[2]{
  \node[#1, cell fill, draw=none, fit=(sm@cell@current), inner sep=0pt, outer sep=0pt] {};
  \draw[#1, cell border north]    (sm@cell@current.north west) -- (sm@cell@current.north east);
  \draw[#1, cell border south]    (sm@cell@current.south west) -- (sm@cell@current.south east);
  \draw[#1, cell border east]     (sm@cell@current.south east) -- (sm@cell@current.north east);
  \draw[#1, cell border west]     (sm@cell@current.south west) -- (sm@cell@current.north west);
  \begin{scope}
    \clip (sm@cell@current.north west) rectangle (sm@cell@current.south east);
    \path let\p1 = (sm@cell@current.east),\p2 = (sm@cell@current.west) in
    node[#1, cell text, draw=none, fill=none, text width=\dimexpr\x1-\x2\relax, inner sep=0pt, outer sep=0pt] at (sm@cell@current.center) {#2};
  \end{scope}
}

\newcommand\smhead[1][]{\sm@head[#1]}
\newcommand\smheadnorth[1][]{\sm@draw@north{\sm@head@figure[rotate=180,#1]{3mm}}}
\newcommand\smheadsouth[1][]{\sm@draw@south{\sm@head@figure[rotate=  0,#1]{3mm}}}
\newcommand\smheadeast [1][]{\sm@draw@east {\sm@head@figure[rotate= 90,#1]{3mm}}}
\newcommand\smheadwest [1][]{\sm@draw@west {\sm@head@figure[rotate=-90,#1]{3mm}}}

\newcommand\sm@head@figure[2][]{%
  \begin{tikzpicture}%
    \fill[rounded corners=.3*#2,#1] (0, 0) -- (-.6 * #2, -#2) -- (.6 * #2, -#2) -- (0, 0);%
  \end{tikzpicture}%
}


\newcommand\sm@head@from@north[2][]{
  \node[anchor=south,  outer sep=0, inner sep=0] (sm@head)       at (sm@cell@current.north)  {\sm@head@figure[rotate=180,#1]{3mm}};
  \node[anchor=south,  outer sep=0, inner sep=0] (sm@head@other) at ($(sm@cell@current.north) +(-#2,0)$)  {\sm@head@figure[rotate=180,opacity=.4,#1]{3mm}};
%  \node[anchor=south,  outer sep=0, inner sep=0]                 at ($(sm@cell@current.north) +(-#2,0)$)  {\sm@head@figure[rotate=180,#1, fill=white, opacity=.6]{3mm}};
  \path[->,#1] (sm@head@other) edge (sm@head);
}
\newcommand\sm@head@from@south[2][]{
  \node[anchor=north,  outer sep=0, inner sep=0] (sm@head)       at (sm@cell@current.south)  {\sm@head@figure[#1]{3mm}};
  \node[anchor=north,  outer sep=0, inner sep=0] (sm@head@other) at ($(sm@cell@current.south) +(#2,0)$)  {\sm@head@figure[opacity=.4,#1]{3mm}};
%  \node[anchor=north,  outer sep=0, inner sep=0]                 at ($(sm@cell@current.south) +(#2,0)$)  {\sm@head@figure[#1, fill=white, opacity=.6]{3mm}};
  \path[->,#1] (sm@head@other) edge (sm@head);
}
\newcommand\sm@head@from@east[2][]{
  \node[anchor=west,  outer sep=0, inner sep=0] (sm@head)       at (sm@cell@current.east)  {\sm@head@figure[rotate= 90,#1]{3mm}};
  \node[anchor=west,  outer sep=0, inner sep=0] (sm@head@other) at ($(sm@cell@current.east) +(0,#2)$)  {\sm@head@figure[rotate= 90,opacity=.4,#1]{3mm}};
%  \node[anchor=west,  outer sep=0, inner sep=0]                 at ($(sm@cell@current.east) +(0,#2)$)  {\sm@head@figure[rotate= 90,#1, fill=white, opacity=.6]{3mm}};
  \path[->,#1] (sm@head@other) edge (sm@head);
}
\newcommand\sm@head@from@west[2][]{
  \node[anchor=east,  outer sep=0, inner sep=0] (sm@head)       at (sm@cell@current.west)  {\sm@head@figure[rotate= -90,#1]{3mm}};
  \node[anchor=east,  outer sep=0, inner sep=0] (sm@head@other) at ($(sm@cell@current.west) +(0,-#2)$)  {\sm@head@figure[rotate= -90,opacity=.4,#1]{3mm}};
%  \node[anchor=east,  outer sep=0, inner sep=0]                 at ($(sm@cell@current.west) +(0,-#2)$)  {\sm@head@figure[rotate= -90,#1, fill=white, opacity=.6]{3mm}};
  \path[->,#1] (sm@head@other) edge (sm@head);
}

\newcommand\sm@transition@internal[6][]{\ensuremath{\ifblank{#1}{}{#1\!:\!} & \mathord{#2} & \mathord{#3} &\mathord{#4} &\mathord{#5} & \mathord{#6} \\}}
\newcommand\sm@transition@aligned[6][]{\ensuremath{\begin{sm@transition@align}\sm@transition@internal[#1]{#2}{#3}{#4}{#5}{#6}\end{sm@transition@align}}}
\newcommand\sm@transition@external\sm@transition@aligned

\newenvironment{sm@transition@align}{%
  \begingroup
  \begin{array}{@{}r@{\,}c@{}c@{}c@{}c@{}c@{}}
}{
  \end{array}
  \endgroup
}

\newcommand\smTMtrans [4][]{\sm@transition@external[#1]{#2}{/}{#3}{,}{#4}}
\newcommand\smTMtransS[3][]{\smTMtrans[#1]{#2}{#3}{\diamond}}
\newcommand\smTMtransL[3][]{\smTMtrans[#1]{#2}{#3}{\triangleleft}}
\newcommand\smTMtransR[3][]{\smTMtrans[#1]{#2}{#3}{\triangleright}}
\newcommand\smTMtransP[3][]{\smTMtrans[#1]{#2}{#3}{+}}
\newcommand\smTMtransM[2][]{\sm@transition@external[#1]{#2}{/}{-}{}{}}

\newcommand\smPAtrans [4][]{\sm@transition@external[#1]{#2}{/}{#3}{/}{#4}}


\newcommand\smAlign[1]{%
  \begingroup
  \let\sm@transition@external\sm@transition@internal
  \ensuremath{
    \begin{sm@transition@align}
      #1
    \end{sm@transition@align}
  }
  \endgroup
}


\newcommand\smGroup[1]{\ensuremath{\left\{\smAlign{#1}\right.}}


\newcommand{\transX}[3]{#1 / #2, #3}
\newcommand{\trans}[2]{\transX{#1}{#2}{\diamond}}
\newcommand{\transG}[2]{\transX{#1}{#2}{\triangleleft}}
\newcommand{\transD}[2]{\transX{#1}{#2}{\triangleright}}
\newcommand{\transPlus}[2]{\transX{#1}{#2}{+}}
\newcommand{\transMoins}[1]{#1/-}

\endinput
