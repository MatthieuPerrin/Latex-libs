% SPDX-License-Identifier: CC-BY-SA-4.0
% Author: Matthieu Perrin
 
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{trees}[2025/06/08 Package for trees]
 
\RequirePackage{keyval}
\RequirePackage{etoolbox}
\RequirePackage{xparse}
\RequirePackage{tikz}
 
\tikzset{
  tree/.code={
    \setcounter{trees@nodes@counter}{0}%
    \setcounter{trees@leaves@counter}{0}%
    \setcounter{trees@depth@counter}{0}%
    \edef\trees@option@edges@style{}%
    \edef\trees@option@nodes@style{}%
    \edef\trees@option@leavs@style{}%
  },
  tree edge/.style={-latex},
  tree node/.style={anchor=base},
  tree node internal/.style={tree node},
  tree node leave/.style={tree node},
}
 
\newcounter{trees@nodes@counter}
\newcounter{trees@leaves@counter}
\newcounter{trees@depth@counter}
 
\edef\trees@sons@list{}
\edef\trees@option@edges@style{}
\edef\trees@option@nodes@style{}
\edef\trees@option@leavs@style{}
\newcommand\trees@setstyle@node[1]{\edef\trees@option@node@style{\trees@option@node@style,#1}}
\newcommand\trees@setstyle@edge[1]{\edef\trees@option@edge@style{\trees@option@edge@style,#1}}
\newcommand\trees@setstyle@edges[1]{\edef\trees@option@edges@style{\trees@option@edges@style,#1}}
\newcommand\trees@setstyle@nodes[1]{\edef\trees@option@nodes@style{\trees@option@nodes@style,#1}}
\newcommand\trees@setstyle@leavs[1]{\edef\trees@option@leavs@style{\trees@option@leavs@style,#1}}
 
\define@key{trees@options}{xshift}{\edef\trees@option@xshift{#1}}
\define@key{trees@options}{yshift}{\edef\trees@option@yshift{#1}}
\define@key{trees@options}{name}{\edef\trees@current@node{#1}}
\define@key{trees@options}{edge}{\trees@setstyle@edge{#1}}
\define@key{trees@options}{node}{\trees@setstyle@node{#1}}
\define@key{trees@options}{edges}{\trees@setstyle@edges{#1}}
\define@key{trees@options}{nodes}{\trees@setstyle@nodes{#1}}
\define@key{trees@options}{leavs}{\trees@setstyle@leavs{#1}}
\define@key{trees@options}{sons}{\trees@setstyle@nodes{#1}\trees@setstyle@leavs{#1}\trees@setstyle@edges{#1}}
\define@key{trees@options}{style}{\trees@setstyle@nodes{#1}\trees@setstyle@leavs{#1}\trees@setstyle@edges{#1}\trees@setstyle@edge{#1}\trees@setstyle@node{#1}}
\define@key{trees@options}{on}{\trees@setstyle@nodes{on=#1}\trees@setstyle@leavs{on=#1}\trees@setstyle@edges{on=#1}\trees@setstyle@edge{on=#1}\trees@setstyle@node{on=#1}}
\define@key{trees@options}{ob}{\trees@setstyle@nodes{ob=#1}\trees@setstyle@leavs{ob=#1}\trees@setstyle@edges{ob=#1}\trees@setstyle@edge{ob=#1}\trees@setstyle@node{ob=#1}}

\newcommand\trees@internal@son{}
\newcommand\trees@internal@node@style{}
\newcommand\trees@internal@edge@style{}
\define@key{trees@internals@options}{son}{\edef\trees@internal@son{#1}}
\define@key{trees@internals@options}{edge}{\edef\trees@internal@edge@style{#1}}
 
\newcommand\tree[3][]{
  \begingroup
  \advance\c@trees@depth@counter by 1
  \edef\trees@current@node{}
  \edef\trees@option@xshift{0}
  \edef\trees@option@yshift{0}
  \edef\trees@option@node@style{}
  \edef\trees@option@edge@style{}
  \edef\trees@option@edge@style{}
  \edef\trees@option@edges@style@saved{\trees@option@edges@style}
  \edef\trees@option@nodes@style@saved{\trees@option@nodes@style}
  \edef\trees@option@leavs@style@saved{\trees@option@leavs@style}
  \setkeys{trees@options}{#1}
  %
  \ifdefempty{\trees@current@node}{
    \stepcounter{trees@nodes@counter}
    \edef\trees@current@node{trees@nodes@\thetrees@nodes@counter}%
  }{}
  %
  \edef\trees@sons@list@toadd{son={\trees@current@node}, edge={\trees@option@edge@style}}
  \edef\trees@sons@list{}
  #3
  \tikzset{tree@leavs@options/.style/.expanded={\trees@option@leavs@style@saved,\trees@option@node@style},}
  \tikzset{tree@nodes@options/.style/.expanded={\trees@option@nodes@style@saved,\trees@option@node@style},}
  \ifdefempty{\trees@sons@list}{
    \stepcounter{trees@leaves@counter}
    \node[tree node leave,tree@leavs@options] (\trees@current@node) at (\thetrees@leaves@counter+\trees@option@xshift,-\thetrees@depth@counter+\trees@option@yshift) {#2}; 
  }{
    \edef\trees@sons@nodes@list{}
    \foreach \c in \trees@sons@list {%
      \edef\temp{\noexpand\setkeys{trees@internals@options}{\c}}\temp
      \xdef\trees@sons@nodes@list{\trees@sons@nodes@list(\trees@internal@son.base)}
    }%
    \node[fit=\trees@sons@nodes@list, inner sep=0, outer sep=0] (trees@internal@box) {};
    \path let \p1 = (trees@internal@box.north) in
    node[tree node internal,tree@nodes@options] (\trees@current@node) at ($(\x1,-\thetrees@depth@counter) + (\trees@option@xshift,\trees@option@yshift)$) {#2};
    \foreach \c in \trees@sons@list {%
      \edef\temp{\noexpand\setkeys{trees@internals@options}{\c}}\temp
      \tikzset{tree@edges@options/.style/.expanded={\trees@option@edges@style,\trees@internal@edge@style},}
      \path[tree edge,tree@edges@options] (\trees@current@node) edge (\trees@internal@son);
    }%
  }
  \xdef\trees@sons@list@toadd@global{\trees@sons@list@toadd}
  \endgroup
  \ifdefempty{\trees@sons@list}{}{\edef\trees@sons@list{\trees@sons@list,}}
  \edef\trees@sons@list{\trees@sons@list{\trees@sons@list@toadd@global}}
}
 
\endinput

